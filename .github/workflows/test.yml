name: test

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  base:
    runs-on: ${{ matrix.os }}-latest
    strategy:
      matrix:
        os: [ubuntu, macos, windows]
        environment: [test-base-py313, test-base-py314, test-base-py314t]
    steps:
      - uses: actions/checkout@v6

      - uses: prefix-dev/setup-pixi@v0.9.4
        with:
          environments: ${{ matrix.environment }}
          cache: true
          locked: true

      - name: Test NetworkX
        run: pixi run -e ${{ matrix.environment }} test-base

  default:
    runs-on: ${{ matrix.os }}-latest
    strategy:
      matrix:
        os: [ubuntu, macos, windows]
        environment:
          [
            test-default-py311,
            test-default-py312,
            test-default-py313,
            test-default-py314,
          ]
    steps:
      - uses: actions/checkout@v6

      - uses: prefix-dev/setup-pixi@v0.9.4
        with:
          environments: ${{ matrix.environment }}
          cache: true
          locked: true

      - name: Test for warnings at import time
        run: pixi run -e ${{ matrix.environment }} check-import

      - name: Test NetworkX
        run: pixi run -e ${{ matrix.environment }} test-default

  default-without-scipy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: prefix-dev/setup-pixi@v0.9.4
        with:
          environments: test-default-no-scipy-py312
          cache: true
          locked: true

      - name: Test for warnings at import time
        run: pixi run -e test-default-no-scipy-py312 check-import

      - name: Test NetworkX
        run: pixi run -e test-default-no-scipy-py312 test-default

  dispatch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: prefix-dev/setup-pixi@v0.9.4
        with:
          environments: test-default-py314
          cache: true
          locked: true

      - name: Test Dispatching
        run: pixi run -e test-default-py314 test-dispatch

  extra:
    runs-on: ${{ matrix.os }}-latest
    strategy:
      matrix:
        os: [ubuntu, macos, windows]
        environment: [test-extra-py311, test-extra-py312, test-extra-py313]
    steps:
      - uses: actions/checkout@v6

      - uses: prefix-dev/setup-pixi@v0.9.4
        with:
          environments: ${{ matrix.environment }}
          cache: true
          locked: true

      - name: Test NetworkX
        run: pixi run -e ${{ matrix.environment }} test-default

  prerelease:
    runs-on: ${{ matrix.os }}-latest
    strategy:
      matrix:
        os: [ubuntu, macos]
        python-version: ["3.11", "3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install packages
        run: |
          pip install --upgrade pip
          pip install --pre .[default,test]
          pip list

      - name: Test NetworkX
        run: |
          pytest -n auto --doctest-modules --durations=10 --pyargs networkx

  slow-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: prefix-dev/setup-pixi@v0.9.4
        with:
          environments: test-default-py313
          cache: true
          locked: true

      - name: Run slow tests
        # NOTE: --runslow adds slow tests to the collection while -m slow
        # filters out tests that are *not* marked slow, leaving only the
        # slow tests
        run: pixi run -e test-default-py313 test-slow
